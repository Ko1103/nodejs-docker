# Best Practice Node.js Dockerfile

このリポジトリはNode.jsのDockerfileを作る上でのベストプラクティスをまとめたものです。

以下にそれぞれのベストプラクティスについて説明します。

## 1. ベースイメージは偶数バージョンを使う

Node.jsは偶数のバージョンがLTS(Long Term Support)となっています。そのため、ベースイメージには偶数バージョンを使うことをお勧めします。

## 2. ワーキングディレクトリを設定する

ワーキングディレクトリを設定することで、コンテナ内での作業がしやすくなります。また、ディレクトリに権限設定を行うことで、セキュリティを向上させることができます。

## 3. パッケージのインストールを最適化する

パッケージのインストールを最適化することで、ビルド時間を短縮することができます。また、Dockerのレイヤーキャッシュを活用することで、ビルドの再実行を高速化することができます。
Dockerfileには例として、 `package.json`と `package-lock.json`のファイルをコピーし、パッケージのインストールを行ったあとに他のファイルをコピーするように記述することで、上記のファイルが変更された場合のみパッケージのインストールを行うようにしています。

## 4. npmrcファイルはmountして使う

npmrcファイルをDockerfileに直接コピーすることはセキュリティ上のリスクがあるため、npmrcファイルはmountして使うことをお勧めします。
他にもビルド時に必要な環境変数はなるべくDockerレイヤーに含めないことをお勧めします。

## 5. マルチステージビルドを活用する

TypeScriptのプロジェクトならもちろんですが、ビルド時に必要なものはビルド用のコンテナでビルドし、実行時に必要なものだけを含むコンテナは別で作ることで、イメージサイズを小さくすることができます。

## 6. プロダクションステージのベースコンテナは小さいものを使う

ビルド時にはビルド用のツールが必要ですが、実際にプロダクションでサーバを稼働させるためにはそれらのツールは不要です。そのため、ビルド時にはビルド用のツールを含むイメージを使い、実際にプロダクションでサーバを稼働させるためにはそれらのツールを含まないイメージを使うことをお勧めします。Node.jsの場合、 `alpine`, `slim`などの小さいイメージを使うことをお勧めします。

## 7. Userを設定する

Dockerコンテナはデフォルトでrootユーザーで実行されますが、セキュリティ上のリスクがあるため、Userを設定することをお勧めします。

## 8. プロダクションで利用しないpackageは削除する

プロダクションで利用しないpackageは削除することで、イメージサイズを小さくすることができます。削除方法は `npm prune --production`または `npm ci --only=production`で対応できます。

## 9. ポートをエクスポートする

コンテナ外部からアクセスできるポートを明示的に設定することで、セキュリティを向上させることができます。

## 10. Entry Pointを設定する

コンテナが起動したときに実行されるコマンドを設定することで、コンテナの挙動を制御することができます。実行するコマンドが固定されるので、セキュリティを向上させることができます。
